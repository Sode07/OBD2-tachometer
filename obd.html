<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBD2 Tachometer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background-color: #00ff00;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: background-color 0.3s ease;
    }

    h1 {
      font-size: 2.5rem;
      color: white;
      margin-bottom: 2rem;
      background-color: #1a1a1a;
      padding: 0.5rem 1rem;
      border-radius: 8px;
    }

    .upload-container {
      background-color: #2a2a2a;
      padding: 3rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      color: #60a5fa;
    }

    .upload-label {
      color: white;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: block;
    }

    input[type="file"] {
      display: none;
    }

    .upload-button {
      background-color: #2563eb;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }

    .upload-button:hover {
      background-color: #1d4ed8;
    }

    .tachometer-container {
      position: relative;
      width: 400px;
      height: 400px;
      display: none;
    }

    .tachometer-container.active {
      display: block;
    }

    .info-display {
      position: absolute;
      bottom: 0px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 0 2rem;
    }

    .info-box {
      text-align: center;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      position: absolute;
      bottom: 50px;
    }


    .info-value {
      color: white;
      font-size: 5rem;
      font-weight: bold;
    }

    .info-label {
      color: #9ca3af;
      font-size: 0.875rem;
    }
    #bgPicker {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      vertical-align: middle;
    }

    .controls {
      margin-top: 2rem;
      width: 400px;
      background-color: #2a2a2a;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: none;
    }

    .controls.active {
      display: block;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:hover {
      background-color: #1d4ed8;
    }

    button.reset {
      background-color: #4b5563;
    }

    button.reset:hover {
      background-color: #374151;
    }

    .time-display {
      flex: 1;
      text-align: right;
      color: white;
    }

    .time-current {
      font-size: 1.5rem;
      font-family: monospace;
    }

    .time-total {
      color: #9ca3af;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #4b5563;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #2563eb;
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #2563eb;
      cursor: pointer;
      border: none;
    }
  </style>
</head>
<body>
  <h1>OBD2 Data Visualizer</h1>
  <div class="picker-container">
    <label for="bgPicker">Change Background:</label>
    <input type="color" id="bgPicker" value="#00ff00">
  </div>

  <div id="uploadSection" class="upload-container">
    <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
    <label class="upload-label">Upload XML Data File</label>
    <label for="fileInput" class="upload-button">Choose File</label>
    <input type="file" id="fileInput" accept=".vtlog">
  </div>

  <div id="tachometer" class="tachometer-container">
    <svg viewBox="0 0 400 400" width="400" height="400">
      <defs>
        <filter id="glow">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <linearGradient id="needleGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ff4444" />
          <stop offset="100%" stop-color="#cc0000" />
        </linearGradient>
        <mask id="arcMask">
          <path d="M 200 200 L 200 20 A 180 180 0 1 1 343.137 293.137 Z" fill="white" />
        </mask>
      </defs>
      
      <circle cx="200" cy="200" r="180" fill="none" stroke="#333" stroke-width="20" opacity="0.3" mask="url(#arcMask)"/>
      <circle cx="200" cy="200" r="170" fill="none" stroke="#222" stroke-width="2" opacity="0.5" mask="url(#arcMask)"/>
      
      <g id="marks"></g>
      <g id="needle" transform="rotate(0 200 200)">
        <path d="M 200 200 L 195 210 L 200 50 L 205 210 Z" fill="url(#needleGrad)" filter="url(#glow)" />
      </g>
      
      <circle cx="200" cy="200" r="15" fill="#333" stroke="#ff4444" stroke-width="2"/>
      
    </svg>

    <div class="info-display">
      <div class="info-box">
        <div class="info-value" id="speedValue">0</div>
        <div class="info-label">km/h</div>
      </div>
    </div>
  </div>

  <div id="controls" class="controls">
    <div class="button-group">
      <button id="playPauseBtn">
        <svg id="playIcon" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
        <svg id="pauseIcon" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" style="display:none;">
          <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
        </svg>
      </button>
      <button id="resetBtn" class="reset">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      </button>
      <div class="time-display">
        <span class="time-current" id="currentTime">0.00</span>
        <span class="time-total"> / <span id="totalTime">0.00</span>s</span>
      </div>
    </div>
    <input type="range" id="timeSlider" min="0" max="1" step="0.01" value="0">
  </div>

  <script>
    let xmlData = null;
    let currentTime = 0;
    let duration = 0;
    let isPlaying = false;
    let animationId = null;
    let lastTimestamp = 0;

    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const tachometer = document.getElementById('tachometer');
    const controls = document.getElementById('controls');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const timeSlider = document.getElementById('timeSlider');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const speedValue = document.getElementById('speedValue');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const needle = document.getElementById('needle');
    const marks = document.getElementById('marks');

    // Generate tick marks
    const startAngle = -210;
    const endAngle = 30;
    const totalSweep = endAngle - startAngle;

    for (let i = 0; i <= 16; i++) {
      const angle = startAngle + (i * totalSweep / 16);
      const isRed = i >= 13;
      const isMajor = i % 2 === 0;
      const r1 = 165;
      const r2 = isMajor ? 145 : 155;
      const rad = (angle * Math.PI) / 180;
      const x1 = 200 + r1 * Math.cos(rad);
      const y1 = 200 + r1 * Math.sin(rad);
      const x2 = 200 + r2 * Math.cos(rad);
      const y2 = 200 + r2 * Math.sin(rad);

      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x1);
      line.setAttribute('y1', y1);
      line.setAttribute('x2', x2);
      line.setAttribute('y2', y2);
      line.setAttribute('stroke', isRed ? '#ff3333' : '#ffffff');
      line.setAttribute('stroke-width', isMajor ? 3 : 2);
      line.setAttribute('opacity', 0.8);
      marks.appendChild(line);

      if (isMajor) {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', 200 + 130 * Math.cos(rad));
        text.setAttribute('y', 200 + 130 * Math.sin(rad));
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', isRed ? '#ff3333' : '#ffffff');
        text.setAttribute('font-size', 18);
        text.setAttribute('font-weight', 'bold');
        text.setAttribute('opacity', 0.9);
        text.textContent = i / 2;
        marks.appendChild(text);
      }
    }

    function parseXML(xmlString) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
      
      const data = { rpm: [], speed: [], throttle: [] };
      const pids = xmlDoc.getElementsByTagName('PID');
      
      for (let pid of pids) {
        const id = pid.getAttribute('ID');
        const records = pid.getElementsByTagName('Record');
        const targetArray = id === '13' ? data.rpm : id === '26' ? data.speed : id === '43' ? data.throttle : null;
        
        if (targetArray) {
          for (let record of records) {
            targetArray.push({
              time: parseFloat(record.getAttribute('Time')),
              value: parseFloat(record.getAttribute('Value'))
            });
          }
        }
      }
      
      return data;
    }

    function getValueAtTime(dataArray, time) {
      if (!dataArray || dataArray.length === 0) return 0;
      
      for (let i = 0; i < dataArray.length - 1; i++) {
        if (time >= dataArray[i].time && time <= dataArray[i + 1].time) {
          const t = (time - dataArray[i].time) / (dataArray[i + 1].time - dataArray[i].time);
          return dataArray[i].value + t * (dataArray[i + 1].value - dataArray[i].value);
        }
      }
      
      if (time >= dataArray[dataArray.length - 1].time) {
        return dataArray[dataArray.length - 1].value;
      }
      
      return dataArray[0].value;
    }

    function updateDisplay() {
      if (!xmlData) return;

      const rpm = getValueAtTime(xmlData.rpm, currentTime);
      const speed = getValueAtTime(xmlData.speed, currentTime);
      const throttle = getValueAtTime(xmlData.throttle, currentTime);

      const maxRPM = 8000;
      const rpmAngle = 240 + (rpm / maxRPM) * totalSweep;

      needle.setAttribute('transform', `rotate(${rpmAngle} 200 200)`);
      speedValue.textContent = Math.round(speed);
      currentTimeEl.textContent = currentTime.toFixed(2);
      timeSlider.value = currentTime;
    }

    function animate(timestamp) {
      if (!isPlaying) return;

      if (lastTimestamp === 0) {
        lastTimestamp = timestamp;
      }

      const delta = (timestamp - lastTimestamp) / 1000;
      lastTimestamp = timestamp;

      currentTime += delta;
      
      if (currentTime >= duration) {
        currentTime = duration;
        isPlaying = false;
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        lastTimestamp = 0;
      }

      updateDisplay();

      if (isPlaying) {
        animationId = requestAnimationFrame(animate);
      }
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          xmlData = parseXML(e.target.result);
          
          duration = Math.max(
            ...xmlData.rpm.map(r => r.time),
            ...xmlData.speed.map(r => r.time),
            ...xmlData.throttle.map(r => r.time)
          );
          
          currentTime = 0;
          timeSlider.max = duration;
          totalTimeEl.textContent = duration.toFixed(2);
          
          uploadSection.style.display = 'none';
          tachometer.classList.add('active');
          controls.classList.add('active');
          
          updateDisplay();
        };
        reader.readAsText(file);
      }
    });

    playPauseBtn.addEventListener('click', () => {
      isPlaying = !isPlaying;
      
      if (isPlaying) {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        lastTimestamp = 0;
        animationId = requestAnimationFrame(animate);
      } else {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        if (animationId) {
          cancelAnimationFrame(animationId);
        }
      }
    });

    resetBtn.addEventListener('click', () => {
      isPlaying = false;
      currentTime = 0;
      lastTimestamp = 0;
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      updateDisplay();
    });

    timeSlider.addEventListener('input', (e) => {
      currentTime = parseFloat(e.target.value);
      isPlaying = false;
      lastTimestamp = 0;
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      updateDisplay();
    });
  </script>
  <script>
  document.getElementById('bgPicker').addEventListener('input', function(e) {
    document.body.style.backgroundColor = e.target.value;
  });
</script>
</body>
</html>